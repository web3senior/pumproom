import OpenAI from 'openai'
import Web3 from 'web3'
import LSP7ABI from '../../app/abi/lsp7.json'
import ARFIAirdropABI from '../../app/abi/airdrop.json'
import { ethers } from 'ethers'

// export const config = {
//   maxDuration: 60, // 5 seconds
// };
export const maxDuration = 60 // This function can run for a maximum of 5 seconds

const openai = new OpenAI({
  dangerouslyAllowBrowser: false,
  apiKey: process.env.OPENAI_API_KEY,
})

const airdropContractAddress = '0x69a7373E94fE85256f104Bf327b6D3d9ca81c08E'

let messages = [
  {
    role: 'system',
    content: `Use LUKSO in uppercase in all instances, including hashtags.`,
  },
  {
    role: 'system',
    content: `Your name is PumpRoom and you can create LUKSO LSP7 token and deploy it on LUKSO blockchain. In order to 
    create LSP7 you need to ask for token Name, Symbol, Total Supply and wallet address to transfer ownership of deployed token. After deploying the token provideo the all links about the token/ contract.`,
  },
  {
    role: 'system',
    content: `
    Amir contact information:
    Universal Profile address: https://profile.link/arattalabs@0D5C
    fullname: Amir Rahimi
    birthday: 1994-07-18
    geneder: male
    email: atenyun@gmail.com
    telegram id: @atenyun
    twitter: @atenyun
    generate a link for my telegram & twitter id
    `,
  },
  {
    role: 'system',
    content: `In order to read users wallet address ask them to connect their wallet to the DApp.`,
  },  

  {
    role: 'system',
    content: `Link the all transactions hash e.g. https://explorer.lukso.network/tx/[TX]`,
  },
  {
    role: 'system',
    content: `Link to contract on the explorer https://explorer.lukso.network/address/[CONTRACT_ADDRESS]`,
  },
  {
    role: 'system',
    content: `Link to add liquidity on Universal Swap https://universalswaps.io/add/[CONTRACT_ADDRESS]`,
  },
  {
    role: 'system',
    content: `Link to trade lsp7 token on Universal Swap https://universalswaps.io/tokens/lukso/[CONTRACT_ADDRESS]`,
  },

]

let tools = [
  {
    type: 'function',
    function: {
      name: 'create_token',
      description: `Create LSP7 token on LUKSO`,
      parameters: {
        type: 'object',
        properties: {
          wallet: {
            type: 'string',
            description: `Wallet address to transfer ownership of the deployed token.`,
          },
          name: {
            type: 'string',
            description: `Token name`,
          },
          symbol: {
            type: 'string',
            description: `Token symbol`,
          },
          supply: {
            type: 'number',
            description: `Total supply`,
          },
        },
        required: ['wallet', 'name', 'symbol', 'supply'],
        additionalProperties: false,
      },
      strict: true,
    },
  },
  {
    type: 'function',
    function: {
      name: 'get_total_holder',
      description: 'Count of token holders. Total holders of a token',
      parameters: {
        type: 'object',
        properties: {
          contract: {
            type: 'string',
            description: 'Starts with 0x e.g. 0xf76253bddf123543716092e77fc08ba81d63ff38. Default value is 0xf76253bddf123543716092e77fc08ba81d63ff38',
          },
        },
        required: ['contract'],
        additionalProperties: false,
      },
      strict: false,
    },
  },
  {
    type: 'function',
    function: {
      name: 'get_lsp7',
      description: 'search tokens info, holders, whales by contract address. Convert numbers from WEI to ETH',
      parameters: {
        type: 'object',
        properties: {
          contract: {
            type: 'string',
            description: 'Starts with 0x e.g. 0xf76253bddf123543716092e77fc08ba81d63ff38',
          },
        },
        required: ['contract'],
        additionalProperties: false,
      },
      strict: false,
    },
  },
  {
    type: 'function',
    function: {
      name: 'search_profile',
      description: 'search and find profiles by a name or wallet address with 42 character length start with 0x like 0x6f77D2853dC02e1cF6fF5AF17040B3b6abBD2dca and make it precise',
      parameters: {
        type: 'object',
        properties: {
          wallet: {
            type: 'string',
            description: 'Profile username, name or wallet address which starts with 0x e.g. 0x6f77D2853dC02e1cF6fF5AF17040B3b6abBD2dca',
          },
        },
        required: ['wallet'],
        additionalProperties: false,
      },
      strict: true,
    },
  },
]

async function create_token(args) {
  // owner, name, symbol, supply
  console.log(`Parameters => `, args)
  if (args.wallet === `null`) return { result: false, data: `You need to connect your wallet and retry!` }

  const RPC_ENDPOINT = 'https://rpc.mainnet.lukso.network'
  const web3 = new Web3(RPC_ENDPOINT)
  const privateKey = '0xf8ede5f13b521b2b97939b657c1b1afc4ee3c1185d644b4451b995e5eb3763d0'
  const account = web3.eth.accounts.privateKeyToAccount(privateKey)

  const lsp7Contract = new web3.eth.Contract(LSP7ABI)
  // const tokenToAirdrop = new web3.eth.Contract(LSP7ABI, '0x39f73b9c8d4e370fd9ff22c932ed58009680aff0')

  // Check if user is claimed the token already
  //const isWalletCliamed = web3.utils.toNumber(await airdropContract.methods.claimed(wallet).call())
  //console.log(`isWalletCliamed => `, isWalletCliamed > 0 ? 'yes' : 'no')
  //if (isWalletCliamed > 0) return { result: false, data: `This user is cliamed its fish already` }
  // console.log(await tokenToAirdrop.methods.balanceOf(airdropContractAddress).call(), `ether`))
  try {
    const contractDeployer = lsp7Contract.deploy({
      data:
        `0x` +
        `608060405234801561000f575f5ffd5b506040516157e33803806157e383398181016040528101906100319190610aa8565b8282335f5f848484848484848484815f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036100a5576040517f1ad8836c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6100b48161027060201b60201c565b5061011c7feafec4d89fa9619884b60000a4d96624a38f7ac2d8d9a604ecf07c12c77e480c5f1b6040518060400160405280600481526020017fa4d966240000000000000000000000000000000000000000000000000000000081525061036d60201b60201c565b61014e7fdeba1e292f8ba88238e10ab3c7f88bd4be4fac56cad5194b6ecceaf653468af15f1b8561036d60201b60201c565b6101807f2f0a68ab07768e01943a599e73362a0e17a63a72e94dd2e384d2c1d4db9327565f1b8461036d60201b60201c565b6101d17fe0261fa95db2eb3b5439bd033cda66d56b96f92f243a8228fd87550ed7bdfdb35f1b826040516020016101b79190610b3f565b60405160208183030381529060405261036d60201b60201c565b505050508060025f6101000a81548160ff021916908315150217905550505050505050505050506102066103c860201b60201c565b600a6102129190610cc0565b8161021d9190610d0a565b600781905550610268336102356103c860201b60201c565b600a6102419190610cc0565b8361024c9190610d0a565b600160405180602001604052805f8152506103ea60201b60201c565b505050611367565b61027e61041060201b60201c565b73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161461036a578073ffffffffffffffffffffffffffffffffffffffff165f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3805f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b50565b8060015f8481526020019081526020015f20908161038b9190610f52565b50817fece574603820d07bc9b91f2a932baadf4628aabcb8afba49776529c14a6104b2826040516103bc9190611069565b60405180910390a25050565b5f60025f9054906101000a900460ff166103e35760126103e5565b5f5b905090565b6103f861043760201b60201c565b61040a848484846104b660201b60201c565b50505050565b5f5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b3373ffffffffffffffffffffffffffffffffffffffff1661045c61041060201b60201c565b73ffffffffffffffffffffffffffffffffffffffff16146104b457336040517fbf1169c50000000000000000000000000000000000000000000000000000000081526004016104ab91906110c8565b60405180910390fd5b565b600754836104c861053e60201b60201c565b6104d291906110e1565b1115610526576104e661053e60201b60201c565b6007546040517f3dc729a700000000000000000000000000000000000000000000000000000000815260040161051d929190611114565b60405180910390fd5b6105388484848461054760201b60201c565b50505050565b5f600354905090565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16036105ac576040517fd2d5ec3000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6105be5f8585846106fe60201b60201c565b8260035f8282546105cf91906110e1565b925050819055508260045f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825461062291906110e1565b925050819055508373ffffffffffffffffffffffffffffffffffffffff165f73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f3997e418d2cef0b3b0e907b1e39605c3f7d32dbd061e82ea5b4a770d46a160a68686866040516106a193929190611155565b60405180910390a46106bb5f85858461070460201b60201c565b5f335f8686856040516020016106d5959493929190611191565b60405160208183030381529060405290506106f785848361070a60201b60201c565b5050505050565b50505050565b50505050565b61072183636bb56a1460e01b61086f60201b60201c565b156107cc578273ffffffffffffffffffffffffffffffffffffffff16636bb56a147f20804611b3e2ea21c480dc465142210acf4a2485947541770ec1fb87dee4a55c5f1b836040518363ffffffff1660e01b8152600401610783929190611201565b5f604051808303815f875af115801561079e573d5f5f3e3d5ffd5b505050506040513d5f823e3d601f19601f820116820180604052508101906107c691906112cd565b5061086a565b81610869575f8373ffffffffffffffffffffffffffffffffffffffff163b1461082c57826040517fa608fbb600000000000000000000000000000000000000000000000000000000815260040161082391906110c8565b60405180910390fd5b826040517f26c247f400000000000000000000000000000000000000000000000000000000815260040161086091906110c8565b60405180910390fd5b5b505050565b5f5f6301ffc9a760e01b8360405160240161088a919061134e565b604051602081830303815290604052907bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f5f5f60205f8551602087018a617530fa92503d91505f519050828015610911575060208210155b801561091c57505f81115b94505050505092915050565b5f604051905090565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b61098782610941565b810181811067ffffffffffffffff821117156109a6576109a5610951565b5b80604052505050565b5f6109b8610928565b90506109c4828261097e565b919050565b5f67ffffffffffffffff8211156109e3576109e2610951565b5b6109ec82610941565b9050602081019050919050565b8281835e5f83830152505050565b5f610a19610a14846109c9565b6109af565b905082815260208101848484011115610a3557610a3461093d565b5b610a408482856109f9565b509392505050565b5f82601f830112610a5c57610a5b610939565b5b8151610a6c848260208601610a07565b91505092915050565b5f819050919050565b610a8781610a75565b8114610a91575f5ffd5b50565b5f81519050610aa281610a7e565b92915050565b5f5f5f60608486031215610abf57610abe610931565b5b5f84015167ffffffffffffffff811115610adc57610adb610935565b5b610ae886828701610a48565b935050602084015167ffffffffffffffff811115610b0957610b08610935565b5b610b1586828701610a48565b9250506040610b2686828701610a94565b9150509250925092565b610b3981610a75565b82525050565b5f602082019050610b525f830184610b30565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f8160011c9050919050565b5f5f8291508390505b6001851115610bda57808604811115610bb657610bb5610b58565b5b6001851615610bc55780820291505b8081029050610bd385610b85565b9450610b9a565b94509492505050565b5f82610bf25760019050610cad565b81610bff575f9050610cad565b8160018114610c155760028114610c1f57610c4e565b6001915050610cad565b60ff841115610c3157610c30610b58565b5b8360020a915084821115610c4857610c47610b58565b5b50610cad565b5060208310610133831016604e8410600b8410161715610c835782820a905083811115610c7e57610c7d610b58565b5b610cad565b610c908484846001610b91565b92509050818404811115610ca757610ca6610b58565b5b81810290505b9392505050565b5f60ff82169050919050565b5f610cca82610a75565b9150610cd583610cb4565b9250610d027fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8484610be3565b905092915050565b5f610d1482610a75565b9150610d1f83610a75565b9250828202610d2d81610a75565b91508282048414831517610d4457610d43610b58565b5b5092915050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680610d9957607f821691505b602082108103610dac57610dab610d55565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f60088302610e0e7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610dd3565b610e188683610dd3565b95508019841693508086168417925050509392505050565b5f819050919050565b5f610e53610e4e610e4984610a75565b610e30565b610a75565b9050919050565b5f819050919050565b610e6c83610e39565b610e80610e7882610e5a565b848454610ddf565b825550505050565b5f5f905090565b610e97610e88565b610ea2818484610e63565b505050565b5b81811015610ec557610eba5f82610e8f565b600181019050610ea8565b5050565b601f821115610f0a57610edb81610db2565b610ee484610dc4565b81016020851015610ef3578190505b610f07610eff85610dc4565b830182610ea7565b50505b505050565b5f82821c905092915050565b5f610f2a5f1984600802610f0f565b1980831691505092915050565b5f610f428383610f1b565b9150826002028217905092915050565b610f5b82610d4b565b67ffffffffffffffff811115610f7457610f73610951565b5b610f7e8254610d82565b610f89828285610ec9565b5f60209050601f831160018114610fba575f8415610fa8578287015190505b610fb28582610f37565b865550611019565b601f198416610fc886610db2565b5f5b82811015610fef57848901518255600182019150602085019450602081019050610fca565b8683101561100c5784890151611008601f891682610f1b565b8355505b6001600288020188555050505b505050505050565b5f82825260208201905092915050565b5f61103b82610d4b565b6110458185611021565b93506110558185602086016109f9565b61105e81610941565b840191505092915050565b5f6020820190508181035f8301526110818184611031565b905092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6110b282611089565b9050919050565b6110c2816110a8565b82525050565b5f6020820190506110db5f8301846110b9565b92915050565b5f6110eb82610a75565b91506110f683610a75565b925082820190508082111561110e5761110d610b58565b5b92915050565b5f6040820190506111275f830185610b30565b6111346020830184610b30565b9392505050565b5f8115159050919050565b61114f8161113b565b82525050565b5f6060820190506111685f830186610b30565b6111756020830185611146565b81810360408301526111878184611031565b9050949350505050565b5f60a0820190506111a45f8301886110b9565b6111b160208301876110b9565b6111be60408301866110b9565b6111cb6060830185610b30565b81810360808301526111dd8184611031565b90509695505050505050565b5f819050919050565b6111fb816111e9565b82525050565b5f6040820190506112145f8301856111f2565b81810360208301526112268184611031565b90509392505050565b5f67ffffffffffffffff82111561124957611248610951565b5b61125282610941565b9050602081019050919050565b5f61127161126c8461122f565b6109af565b90508281526020810184848401111561128d5761128c61093d565b5b6112988482856109f9565b509392505050565b5f82601f8301126112b4576112b3610939565b5b81516112c484826020860161125f565b91505092915050565b5f602082840312156112e2576112e1610931565b5b5f82015167ffffffffffffffff8111156112ff576112fe610935565b5b61130b848285016112a0565b91505092915050565b5f7fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b61134881611314565b82525050565b5f6020820190506113615f83018461133f565b92915050565b61446f806113745f395ff3fe608060405260043610610143575f3560e01c806370a08231116100b55780638da5cb5b1161006e5780638da5cb5b146105165780639790242114610540578063b49506fd1461055c578063d72fc29a14610584578063dedff9c6146105c0578063f2fde38b146105fc576101bc565b806370a0823114610430578063715018a61461046c5780637580d92014610482578063760d9bba146104aa57806378381670146104d25780637f23690c146104fa576101bc565b8063313ce56711610107578063313ce5671461030057806344d171871461032a57806352058d8a1461035257806354f6127f1461037c57806365aeaa95146103b85780636963d438146103f4576101bc565b806301ffc9a71461022257806318160ddd1461025e5780632bc1da82146102885780632d7667c9146102b057806330d0dc37146102d8576101bc565b366101bc575f340361018a576040517fe5099ee30000000000000000000000000000000000000000000000000000000081526004016101819061299d565b60405180910390fd5b6040517f388f5adc00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f36606060045f369050101561020b5782826040517fe5099ee3000000000000000000000000000000000000000000000000000000008152600401610202929190612a05565b60405180910390fd5b6102158383610624565b9050915050805190602001f35b34801561022d575f5ffd5b5061024860048036038101906102439190612a8d565b61079a565b6040516102559190612ad2565b60405180910390f35b348015610269575f5ffd5b5061027261080a565b60405161027f9190612b03565b60405180910390f35b348015610293575f5ffd5b506102ae60048036038101906102a99190612cbe565b610813565b005b3480156102bb575f5ffd5b506102d660048036038101906102d19190613076565b6108ba565b005b3480156102e3575f5ffd5b506102fe60048036038101906102f99190613179565b6109cc565b005b34801561030b575f5ffd5b50610314610ac6565b6040516103219190613214565b60405180910390f35b348015610335575f5ffd5b50610350600480360381019061034b9190612cbe565b610ae8565b005b34801561035d575f5ffd5b50610366610b37565b6040516103739190612b03565b60405180910390f35b348015610387575f5ffd5b506103a2600480360381019061039d9190613260565b610b3d565b6040516103af91906132db565b60405180910390f35b3480156103c3575f5ffd5b506103de60048036038101906103d991906132fb565b610b4f565b6040516103eb9190612b03565b60405180910390f35b3480156103ff575f5ffd5b5061041a60048036038101906104159190613392565b610c4a565b60405161042791906134e0565b60405180910390f35b34801561043b575f5ffd5b5061045660048036038101906104519190613500565b610dc0565b6040516104639190612b03565b60405180910390f35b348015610477575f5ffd5b50610480610e06565b005b34801561048d575f5ffd5b506104a860048036038101906104a3919061352b565b610e19565b005b3480156104b5575f5ffd5b506104d060048036038101906104cb91906135ab565b610e33565b005b3480156104dd575f5ffd5b506104f860048036038101906104f3919061363e565b610e86565b005b610514600480360381019061050f91906136be565b610fc9565b005b348015610521575f5ffd5b5061052a611018565b6040516105379190613727565b60405180910390f35b61055a60048036038101906105559190613800565b61103f565b005b348015610567575f5ffd5b50610582600480360381019061057d9190612cbe565b611151565b005b34801561058f575f5ffd5b506105aa60048036038101906105a59190613500565b611196565b6040516105b7919061392d565b60405180910390f35b3480156105cb575f5ffd5b506105e660048036038101906105e1919061394d565b6111e4565b6040516105f391906134e0565b60405180910390f35b348015610607575f5ffd5b50610622600480360381019061061d9190613500565b611297565b005b60605f6106535f357fffffffff0000000000000000000000000000000000000000000000000000000016611310565b5090505f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036106e9575f357fffffffff00000000000000000000000000000000000000000000000000000000166040517fbb370b2b0000000000000000000000000000000000000000000000000000000081526004016106e091906139a3565b60405180910390fd5b5f5f8273ffffffffffffffffffffffffffffffffffffffff16348787333460405160200161071a9493929190613a4f565b6040516020818303038152906040526040516107369190613ab9565b5f6040518083038185875af1925050503d805f8114610770576040519150601f19603f3d011682016040523d82523d5f602084013e610775565b606091505b5091509150811561078b57809350505050610794565b80518060208301fd5b92915050565b5f63c52d600860e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614806107f357506107f2826113c6565b5b80610803575061080282611426565b5b9050919050565b5f600354905090565b5f61081e8433610b4f565b90505f810361086457836040517fcba6e97700000000000000000000000000000000000000000000000000000000815260040161085b9190613727565b60405180910390fd5b5f83826108719190613afc565b905061088133868360018761148a565b5f33828560405160200161089793929190613b2f565b60405160208183030381529060405290506108b28682611753565b505050505050565b5f855190508451811415806108d0575083518114155b806108dc575082518114155b806108e8575081518114155b1561091f576040517f263eee8d00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f5b818110156109c3576109b887828151811061093f5761093e613b6b565b5b602002602001015187838151811061095a57610959613b6b565b5b602002602001015187848151811061097557610974613b6b565b5b60200260200101518785815181106109905761098f613b6b565b5b60200260200101518786815181106109ab576109aa613b6b565b5b6020026020010151610e33565b806001019050610921565b50505050505050565b8273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614158015610a3457508373ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614155b15610a7a573383856040517f1a525b32000000000000000000000000000000000000000000000000000000008152600401610a7193929190613b98565b60405180910390fd5b610a8783855f858561148a565b8115610ac0575f835f83604051602001610aa393929190613c0f565b6040516020818303038152906040529050610abe8582611753565b505b50505050565b5f60025f9054906101000a900460ff16610ae1576012610ae3565b5f5b905090565b8273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610b2757610b26338484611784565b5b610b32838383611877565b505050565b60075481565b6060610b4882611aa5565b9050919050565b5f8273ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610bc85760045f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050610c44565b60065f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205490505b92915050565b60608282905067ffffffffffffffff811115610c6957610c68612ba8565b5b604051908082528060200260200182016040528015610c9c57816020015b6060815260200190600190039081610c875790505b5090505f5b83839050811015610db9575f5f3073ffffffffffffffffffffffffffffffffffffffff16868685818110610cd857610cd7613b6b565b5b9050602002810190610cea9190613c57565b604051610cf8929190613cb9565b5f60405180830381855af49150503d805f8114610d30576040519150601f19603f3d011682016040523d82523d5f602084013e610d35565b606091505b509150915081610d8d575f815114610d505780518082602001fd5b826040517fb774c284000000000000000000000000000000000000000000000000000000008152600401610d849190612b03565b60405180910390fd5b80848481518110610da157610da0613b6b565b5b60200260200101819052508260010192505050610ca1565b5092915050565b5f60045f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050919050565b610e0e611b46565b610e175f611bbf565b565b610e21611b46565b610e2d84848484611cb6565b50505050565b8473ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610e7257610e71338685611784565b5b610e7f8585858585611d2c565b5050505050565b8273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614158015610eee57508373ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614155b15610f34573383856040517f98ce2945000000000000000000000000000000000000000000000000000000008152600401610f2b93929190613b98565b60405180910390fd5b5f610f3f8585610b4f565b905082811015610f7b576040517f0ef76c3500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f8382039050610f8f85878360018761148a565b5f858285604051602001610fa593929190613b2f565b6040516020818303038152906040529050610fc08782611753565b50505050505050565b610fd1611b46565b5f341461100a576040517ff36ba73700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6110148282611fd9565b5050565b5f5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b611047611b46565b5f3414611080576040517ff36ba73700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b80518251146110bb576040517f3bcc897900000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f8251036110f5576040517f97da5f9500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f5f90505b825181101561114c5761114183828151811061111957611118613b6b565b5b602002602001015183838151811061113457611133613b6b565b5b6020026020010151611fd9565b8060010190506110fa565b505050565b61115f33848460018561148a565b5f33838360405160200161117593929190613b2f565b60405160208183030381529060405290506111908482611753565b50505050565b60606111dd60055f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20611fe7565b9050919050565b6060815167ffffffffffffffff81111561120157611200612ba8565b5b60405190808252806020026020018201604052801561123457816020015b606081526020019060019003908161121f5790505b5090505f5f90505b82518110156112915761126883828151811061125b5761125a613b6b565b5b6020026020010151611aa5565b82828151811061127b5761127a613b6b565b5b602002602001018190525080600101905061123c565b50919050565b61129f611b46565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603611304576040517f1ad8836c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b61130d81611bbf565b50565b5f5f5f61134969cee78b4094da8601109660b01b857bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916612006565b90505f61135582611aa5565b9050601481511415801561136a57505f815114155b156113ac57806040517f42bfe79f0000000000000000000000000000000000000000000000000000000081526004016113a391906132db565b60405180910390fd5b806113b690613d2b565b60601c6001935093505050915091565b5f63a918fa6b60e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061141f575061141e82612044565b5b9050919050565b5f5f6114386301ffc9a760e01b611310565b5090505f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603611477575f915050611485565b611481818461210d565b9150505b919050565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16036114ef576040517f6355e76600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8473ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1603611554576040517fdab7504700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8260065f8773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055505f8314611693576116278460055f8873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206121c690919063ffffffff16565b50828573ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff167ff772a43bfdf4729b196e3fb54a818b91a2ca6c49d10b2e16278752f9f515c25d8460405161168691906132db565b60405180910390a461174c565b6116e28460055f8873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206121f390919063ffffffff16565b508115158573ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff167f0ebf5762d8855cbe012d2ca42fb33a81175e17c8a8751f8859931ba453bd41678460405161174391906132db565b60405180910390a45b5050505050565b611780827f386072cc5a58e61263b434c722725f21031cd06e7c552cfaa06db5de8a320dbc5f1b83612220565b5050565b5f60065f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205490508082111561184b57828185846040517ff3a6b6910000000000000000000000000000000000000000000000000000000081526004016118429493929190613d91565b60405180910390fd5b6118718385848461185c9190613dd4565b5f60405180602001604052805f81525061148a565b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036118dc576040517fd2d5ec3000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6118e8835f84846122da565b5f60045f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905080831115611972578084846040517f08d4794900000000000000000000000000000000000000000000000000000000815260040161196993929190613e07565b60405180910390fd5b8260035f8282546119839190613dd4565b925050819055508260045f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546119d69190613dd4565b925050819055505f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f3997e418d2cef0b3b0e907b1e39605c3f7d32dbd061e82ea5b4a770d46a160a6865f87604051611a5593929190613e3c565b60405180910390a4611a69845f85856122e0565b5f33855f8686604051602001611a83959493929190613e78565b6040516020818303038152906040529050611a9e85826122e6565b5050505050565b606060015f8381526020019081526020015f208054611ac390613efd565b80601f0160208091040260200160405190810160405280929190818152602001828054611aef90613efd565b8015611b3a5780601f10611b1157610100808354040283529160200191611b3a565b820191905f5260205f20905b815481529060010190602001808311611b1d57829003601f168201915b50505050509050919050565b3373ffffffffffffffffffffffffffffffffffffffff16611b65611018565b73ffffffffffffffffffffffffffffffffffffffff1614611bbd57336040517fbf1169c5000000000000000000000000000000000000000000000000000000008152600401611bb49190613727565b60405180910390fd5b565b611bc7611018565b73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614611cb3578073ffffffffffffffffffffffffffffffffffffffff165f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3805f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b50565b60075483611cc261080a565b611ccc9190613afc565b1115611d1a57611cda61080a565b6007546040517f3dc729a7000000000000000000000000000000000000000000000000000000008152600401611d11929190613f2d565b60405180910390fd5b611d2684848484612317565b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff161480611d9157505f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16145b15611dc8576040517fd2d5ec3000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b611dd4858585846122da565b5f60045f8773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905080841115611e5e578086856040517f08d47949000000000000000000000000000000000000000000000000000000008152600401611e5593929190613e07565b60405180910390fd5b8360045f8873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f828254611eaa9190613dd4565b925050819055508360045f8773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f828254611efd9190613afc565b925050819055508473ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f3997e418d2cef0b3b0e907b1e39605c3f7d32dbd061e82ea5b4a770d46a160a6878787604051611f7c93929190613e3c565b60405180910390a4611f90868686856122e0565b5f3387878786604051602001611faa959493929190613e78565b6040516020818303038152906040529050611fc587826122e6565b611fd08685836124bc565b50505050505050565b611fe3828261261b565b5050565b60605f611ff5835f01612787565b905060608190508092505050919050565b5f5f835f60f01b846040516020016120209392919061400a565b60405160208183030381529060405290508061203b9061405a565b91505092915050565b5f63629aa69460e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061209d575061209c826120a4565b5b9050919050565b5f7f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916149050919050565b5f5f6301ffc9a760e01b8360405160240161212891906139a3565b604051602081830303815290604052907bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f5f5f60205f8551602087018a617530fa92503d91505f5190508280156121af575060208210155b80156121ba57505f81115b94505050505092915050565b5f6121eb835f018373ffffffffffffffffffffffffffffffffffffffff165f1b6127e0565b905092915050565b5f612218835f018373ffffffffffffffffffffffffffffffffffffffff165f1b612847565b905092915050565b612250636bb56a1460e01b8473ffffffffffffffffffffffffffffffffffffffff1661210d90919063ffffffff16565b156122d5578273ffffffffffffffffffffffffffffffffffffffff16636bb56a1483836040518363ffffffff1660e01b81526004016122909291906140cf565b5f604051808303815f875af11580156122ab573d5f5f3e3d5ffd5b505050506040513d5f823e3d601f19601f820116820180604052508101906122d3919061416b565b505b505050565b50505050565b50505050565b612313827f429ac7a06903dbc9c13dfcb3c9d11df8194581fa047c96d7a4171fc7402958ea5f1b83612220565b5050565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff160361237c576040517fd2d5ec3000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6123885f8585846122da565b8260035f8282546123999190613afc565b925050819055508260045f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546123ec9190613afc565b925050819055508373ffffffffffffffffffffffffffffffffffffffff165f73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f3997e418d2cef0b3b0e907b1e39605c3f7d32dbd061e82ea5b4a770d46a160a686868660405161246b93929190613e3c565b60405180910390a461247f5f8585846122e0565b5f335f868685604051602001612499959493929190613e78565b60405160208183030381529060405290506124b58584836124bc565b5050505050565b6124cd83636bb56a1460e01b61210d565b15612578578273ffffffffffffffffffffffffffffffffffffffff16636bb56a147f20804611b3e2ea21c480dc465142210acf4a2485947541770ec1fb87dee4a55c5f1b836040518363ffffffff1660e01b815260040161252f9291906140cf565b5f604051808303815f875af115801561254a573d5f5f3e3d5ffd5b505050506040513d5f823e3d601f19601f82011682018060405250810190612572919061416b565b50612616565b81612615575f8373ffffffffffffffffffffffffffffffffffffffff163b146125d857826040517fa608fbb60000000000000000000000000000000000000000000000000000000081526004016125cf9190613727565b60405180910390fd5b826040517f26c247f400000000000000000000000000000000000000000000000000000000815260040161260c9190613727565b60405180910390fd5b5b505050565b7fdeba1e292f8ba88238e10ab3c7f88bd4be4fac56cad5194b6ecceaf653468af15f1b8203612676576040517f85c169bd00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b7f2f0a68ab07768e01943a599e73362a0e17a63a72e94dd2e384d2c1d4db9327565f1b82036126d1576040517f76755b3800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b7fe0261fa95db2eb3b5439bd033cda66d56b96f92f243a8228fd87550ed7bdfdb35f1b820361272c576040517f4ef6d7fb00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8060015f8481526020019081526020015f20908161274a919061433d565b50817fece574603820d07bc9b91f2a932baadf4628aabcb8afba49776529c14a6104b28260405161277b91906132db565b60405180910390a25050565b6060815f018054806020026020016040519081016040528092919081815260200182805480156127d457602002820191905f5260205f20905b8154815260200190600101908083116127c0575b50505050509050919050565b5f6127eb8383612943565b61283d57825f0182908060018154018082558091505060019003905f5260205f20015f9091909190915055825f0180549050836001015f8481526020019081526020015f208190555060019050612841565b5f90505b92915050565b5f5f836001015f8481526020019081526020015f205490505f8114612938575f6001826128749190613dd4565b90505f6001865f018054905061288a9190613dd4565b90508181146128f0575f865f0182815481106128a9576128a8613b6b565b5b905f5260205f200154905080875f0184815481106128ca576128c9613b6b565b5b905f5260205f20018190555083876001015f8381526020019081526020015f2081905550505b855f018054806129035761290261440c565b5b600190038181905f5260205f20015f90559055856001015f8681526020019081526020015f205f90556001935050505061293d565b5f9150505b92915050565b5f5f836001015f8481526020019081526020015f20541415905092915050565b5f82825260208201905092915050565b5f5f82015250565b5f612987600483612963565b915061299282612973565b602082019050919050565b5f6020820190508181035f8301526129b48161297b565b9050919050565b828183375f83830152505050565b5f601f19601f8301169050919050565b5f6129e48385612963565b93506129f18385846129bb565b6129fa836129c9565b840190509392505050565b5f6020820190508181035f830152612a1e8184866129d9565b90509392505050565b5f604051905090565b5f5ffd5b5f5ffd5b5f7fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b612a6c81612a38565b8114612a76575f5ffd5b50565b5f81359050612a8781612a63565b92915050565b5f60208284031215612aa257612aa1612a30565b5b5f612aaf84828501612a79565b91505092915050565b5f8115159050919050565b612acc81612ab8565b82525050565b5f602082019050612ae55f830184612ac3565b92915050565b5f819050919050565b612afd81612aeb565b82525050565b5f602082019050612b165f830184612af4565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f612b4582612b1c565b9050919050565b612b5581612b3b565b8114612b5f575f5ffd5b50565b5f81359050612b7081612b4c565b92915050565b612b7f81612aeb565b8114612b89575f5ffd5b50565b5f81359050612b9a81612b76565b92915050565b5f5ffd5b5f5ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b612bde826129c9565b810181811067ffffffffffffffff82111715612bfd57612bfc612ba8565b5b80604052505050565b5f612c0f612a27565b9050612c1b8282612bd5565b919050565b5f67ffffffffffffffff821115612c3a57612c39612ba8565b5b612c43826129c9565b9050602081019050919050565b5f612c62612c5d84612c20565b612c06565b905082815260208101848484011115612c7e57612c7d612ba4565b5b612c898482856129bb565b509392505050565b5f82601f830112612ca557612ca4612ba0565b5b8135612cb5848260208601612c50565b91505092915050565b5f5f5f60608486031215612cd557612cd4612a30565b5b5f612ce286828701612b62565b9350506020612cf386828701612b8c565b925050604084013567ffffffffffffffff811115612d1457612d13612a34565b5b612d2086828701612c91565b9150509250925092565b5f67ffffffffffffffff821115612d4457612d43612ba8565b5b602082029050602081019050919050565b5f5ffd5b5f612d6b612d6684612d2a565b612c06565b90508083825260208201905060208402830185811115612d8e57612d8d612d55565b5b835b81811015612db75780612da38882612b62565b845260208401935050602081019050612d90565b5050509392505050565b5f82601f830112612dd557612dd4612ba0565b5b8135612de5848260208601612d59565b91505092915050565b5f67ffffffffffffffff821115612e0857612e07612ba8565b5b602082029050602081019050919050565b5f612e2b612e2684612dee565b612c06565b90508083825260208201905060208402830185811115612e4e57612e4d612d55565b5b835b81811015612e775780612e638882612b8c565b845260208401935050602081019050612e50565b5050509392505050565b5f82601f830112612e9557612e94612ba0565b5b8135612ea5848260208601612e19565b91505092915050565b5f67ffffffffffffffff821115612ec857612ec7612ba8565b5b602082029050602081019050919050565b612ee281612ab8565b8114612eec575f5ffd5b50565b5f81359050612efd81612ed9565b92915050565b5f612f15612f1084612eae565b612c06565b90508083825260208201905060208402830185811115612f3857612f37612d55565b5b835b81811015612f615780612f4d8882612eef565b845260208401935050602081019050612f3a565b5050509392505050565b5f82601f830112612f7f57612f7e612ba0565b5b8135612f8f848260208601612f03565b91505092915050565b5f67ffffffffffffffff821115612fb257612fb1612ba8565b5b602082029050602081019050919050565b5f612fd5612fd084612f98565b612c06565b90508083825260208201905060208402830185811115612ff857612ff7612d55565b5b835b8181101561303f57803567ffffffffffffffff81111561301d5761301c612ba0565b5b80860161302a8982612c91565b85526020850194505050602081019050612ffa565b5050509392505050565b5f82601f83011261305d5761305c612ba0565b5b813561306d848260208601612fc3565b91505092915050565b5f5f5f5f5f60a0868803121561308f5761308e612a30565b5b5f86013567ffffffffffffffff8111156130ac576130ab612a34565b5b6130b888828901612dc1565b955050602086013567ffffffffffffffff8111156130d9576130d8612a34565b5b6130e588828901612dc1565b945050604086013567ffffffffffffffff81111561310657613105612a34565b5b61311288828901612e81565b935050606086013567ffffffffffffffff81111561313357613132612a34565b5b61313f88828901612f6b565b925050608086013567ffffffffffffffff8111156131605761315f612a34565b5b61316c88828901613049565b9150509295509295909350565b5f5f5f5f6080858703121561319157613190612a30565b5b5f61319e87828801612b62565b94505060206131af87828801612b62565b93505060406131c087828801612eef565b925050606085013567ffffffffffffffff8111156131e1576131e0612a34565b5b6131ed87828801612c91565b91505092959194509250565b5f60ff82169050919050565b61320e816131f9565b82525050565b5f6020820190506132275f830184613205565b92915050565b5f819050919050565b61323f8161322d565b8114613249575f5ffd5b50565b5f8135905061325a81613236565b92915050565b5f6020828403121561327557613274612a30565b5b5f6132828482850161324c565b91505092915050565b5f81519050919050565b8281835e5f83830152505050565b5f6132ad8261328b565b6132b78185612963565b93506132c7818560208601613295565b6132d0816129c9565b840191505092915050565b5f6020820190508181035f8301526132f381846132a3565b905092915050565b5f5f6040838503121561331157613310612a30565b5b5f61331e85828601612b62565b925050602061332f85828601612b62565b9150509250929050565b5f5ffd5b5f5f83601f84011261335257613351612ba0565b5b8235905067ffffffffffffffff81111561336f5761336e613339565b5b60208301915083602082028301111561338b5761338a612d55565b5b9250929050565b5f5f602083850312156133a8576133a7612a30565b5b5f83013567ffffffffffffffff8111156133c5576133c4612a34565b5b6133d18582860161333d565b92509250509250929050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f82825260208201905092915050565b5f6134208261328b565b61342a8185613406565b935061343a818560208601613295565b613443816129c9565b840191505092915050565b5f6134598383613416565b905092915050565b5f602082019050919050565b5f613477826133dd565b61348181856133e7565b935083602082028501613493856133f7565b805f5b858110156134ce57848403895281516134af858261344e565b94506134ba83613461565b925060208a01995050600181019050613496565b50829750879550505050505092915050565b5f6020820190508181035f8301526134f8818461346d565b905092915050565b5f6020828403121561351557613514612a30565b5b5f61352284828501612b62565b91505092915050565b5f5f5f5f6080858703121561354357613542612a30565b5b5f61355087828801612b62565b945050602061356187828801612b8c565b935050604061357287828801612eef565b925050606085013567ffffffffffffffff81111561359357613592612a34565b5b61359f87828801612c91565b91505092959194509250565b5f5f5f5f5f60a086880312156135c4576135c3612a30565b5b5f6135d188828901612b62565b95505060206135e288828901612b62565b94505060406135f388828901612b8c565b935050606061360488828901612eef565b925050608086013567ffffffffffffffff81111561362557613624612a34565b5b61363188828901612c91565b9150509295509295909350565b5f5f5f5f6080858703121561365657613655612a30565b5b5f61366387828801612b62565b945050602061367487828801612b62565b935050604061368587828801612b8c565b925050606085013567ffffffffffffffff8111156136a6576136a5612a34565b5b6136b287828801612c91565b91505092959194509250565b5f5f604083850312156136d4576136d3612a30565b5b5f6136e18582860161324c565b925050602083013567ffffffffffffffff81111561370257613701612a34565b5b61370e85828601612c91565b9150509250929050565b61372181612b3b565b82525050565b5f60208201905061373a5f830184613718565b92915050565b5f67ffffffffffffffff82111561375a57613759612ba8565b5b602082029050602081019050919050565b5f61377d61377884613740565b612c06565b905080838252602082019050602084028301858111156137a05761379f612d55565b5b835b818110156137c957806137b5888261324c565b8452602084019350506020810190506137a2565b5050509392505050565b5f82601f8301126137e7576137e6612ba0565b5b81356137f784826020860161376b565b91505092915050565b5f5f6040838503121561381657613815612a30565b5b5f83013567ffffffffffffffff81111561383357613832612a34565b5b61383f858286016137d3565b925050602083013567ffffffffffffffff8111156138605761385f612a34565b5b61386c85828601613049565b9150509250929050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b6138a881612b3b565b82525050565b5f6138b9838361389f565b60208301905092915050565b5f602082019050919050565b5f6138db82613876565b6138e58185613880565b93506138f083613890565b805f5b8381101561392057815161390788826138ae565b9750613912836138c5565b9250506001810190506138f3565b5085935050505092915050565b5f6020820190508181035f83015261394581846138d1565b905092915050565b5f6020828403121561396257613961612a30565b5b5f82013567ffffffffffffffff81111561397f5761397e612a34565b5b61398b848285016137d3565b91505092915050565b61399d81612a38565b82525050565b5f6020820190506139b65f830184613994565b92915050565b5f81905092915050565b5f6139d183856139bc565b93506139de8385846129bb565b82840190509392505050565b5f8160601b9050919050565b5f613a00826139ea565b9050919050565b5f613a11826139f6565b9050919050565b613a29613a2482612b3b565b613a07565b82525050565b5f819050919050565b613a49613a4482612aeb565b613a2f565b82525050565b5f613a5b8286886139c6565b9150613a678285613a18565b601482019150613a778284613a38565b60208201915081905095945050505050565b5f613a938261328b565b613a9d81856139bc565b9350613aad818560208601613295565b80840191505092915050565b5f613ac48284613a89565b915081905092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f613b0682612aeb565b9150613b1183612aeb565b9250828201905080821115613b2957613b28613acf565b5b92915050565b5f606082019050613b425f830186613718565b613b4f6020830185612af4565b8181036040830152613b6181846132a3565b9050949350505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f606082019050613bab5f830186613718565b613bb86020830185613718565b613bc56040830184613718565b949350505050565b5f819050919050565b5f819050919050565b5f613bf9613bf4613bef84613bcd565b613bd6565b6131f9565b9050919050565b613c0981613bdf565b82525050565b5f606082019050613c225f830186613718565b613c2f6020830185613c00565b8181036040830152613c4181846132a3565b9050949350505050565b5f5ffd5b5f5ffd5b5f5ffd5b5f5f83356001602003843603038112613c7357613c72613c4b565b5b80840192508235915067ffffffffffffffff821115613c9557613c94613c4f565b5b602083019250600182023603831315613cb157613cb0613c53565b5b509250929050565b5f613cc58284866139c6565b91508190509392505050565b5f819050602082019050919050565b5f7fffffffffffffffffffffffffffffffffffffffff00000000000000000000000082169050919050565b5f613d168251613ce0565b80915050919050565b5f82821b905092915050565b5f613d358261328b565b82613d3f84613cd1565b9050613d4a81613d0b565b92506014821015613d8a57613d857fffffffffffffffffffffffffffffffffffffffff00000000000000000000000083601403600802613d1f565b831692505b5050919050565b5f608082019050613da45f830187613718565b613db16020830186612af4565b613dbe6040830185613718565b613dcb6060830184612af4565b95945050505050565b5f613dde82612aeb565b9150613de983612aeb565b9250828203905081811115613e0157613e00613acf565b5b92915050565b5f606082019050613e1a5f830186612af4565b613e276020830185613718565b613e346040830184612af4565b949350505050565b5f606082019050613e4f5f830186612af4565b613e5c6020830185612ac3565b8181036040830152613e6e81846132a3565b9050949350505050565b5f60a082019050613e8b5f830188613718565b613e986020830187613718565b613ea56040830186613718565b613eb26060830185612af4565b8181036080830152613ec481846132a3565b90509695505050505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680613f1457607f821691505b602082108103613f2757613f26613ed0565b5b50919050565b5f604082019050613f405f830185612af4565b613f4d6020830184612af4565b9392505050565b5f7fffffffffffffffffffff0000000000000000000000000000000000000000000082169050919050565b5f819050919050565b613f99613f9482613f54565b613f7f565b82525050565b5f7fffff00000000000000000000000000000000000000000000000000000000000082169050919050565b5f819050919050565b613fe4613fdf82613f9f565b613fca565b82525050565b5f819050919050565b614004613fff82613ce0565b613fea565b82525050565b5f6140158286613f88565b600a820191506140258285613fd3565b6002820191506140358284613ff3565b601482019150819050949350505050565b5f614051825161322d565b80915050919050565b5f6140648261328b565b8261406e84613cd1565b905061407981614046565b925060208210156140b9576140b47fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff83602003600802613d1f565b831692505b5050919050565b6140c98161322d565b82525050565b5f6040820190506140e25f8301856140c0565b81810360208301526140f481846132a3565b90509392505050565b5f61410f61410a84612c20565b612c06565b90508281526020810184848401111561412b5761412a612ba4565b5b614136848285613295565b509392505050565b5f82601f83011261415257614151612ba0565b5b81516141628482602086016140fd565b91505092915050565b5f602082840312156141805761417f612a30565b5b5f82015167ffffffffffffffff81111561419d5761419c612a34565b5b6141a98482850161413e565b91505092915050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f600883026142027fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82613d1f565b61420c8683613d1f565b95508019841693508086168417925050509392505050565b5f61423e61423961423484612aeb565b613bd6565b612aeb565b9050919050565b5f819050919050565b61425783614224565b61426b61426382614245565b8484546141d3565b825550505050565b5f5f905090565b614282614273565b61428d81848461424e565b505050565b5b818110156142b0576142a55f8261427a565b600181019050614293565b5050565b601f8211156142f5576142c6816141b2565b6142cf846141c4565b810160208510156142de578190505b6142f26142ea856141c4565b830182614292565b50505b505050565b5f82821c905092915050565b5f6143155f19846008026142fa565b1980831691505092915050565b5f61432d8383614306565b9150826002028217905092915050565b6143468261328b565b67ffffffffffffffff81111561435f5761435e612ba8565b5b6143698254613efd565b6143748282856142b4565b5f60209050601f8311600181146143a5575f8415614393578287015190505b61439d8582614322565b865550614404565b601f1984166143b3866141b2565b5f5b828110156143da578489015182556001820191506020850194506020810190506143b5565b868310156143f757848901516143f3601f891682614306565b8355505b6001600288020188555050505b505050505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603160045260245ffdfea2646970667358221220312b03497f1f1038dd8677aefea0d6bcd5908eeca95cd70a0b522bf2dfce68f064736f6c634300081c0033`,
      arguments: [args.name, args.symbol, args.supply],
    })

    const gas = await contractDeployer.estimateGas({
      from: account.address,
    })
    console.log('Estimated gas:', gas)

    const suggestion_gas = await web3.eth.getGasPrice()

    const deployResult = await web3.eth.accounts.signTransaction(
      {
        from: account.address,
        // to: airdropContractAddress,
        gasPrice: web3.utils.toHex(suggestion_gas),
        data: contractDeployer.encodeABI(),
      },
      privateKey
    )

    const res = await web3.eth.sendSignedTransaction(deployResult.rawTransaction)
    console.log(res)

    const tokenAddress = res.logs[0].address

    // New contract
    const deployedTokenContract = new web3.eth.Contract(LSP7ABI, tokenAddress)


    // Transfer token to the new owner
    const transferTokenResult = await web3.eth.accounts.signTransaction(
      {
        from: account.address,
        to: tokenAddress,
        gasPrice: web3.utils.toHex(suggestion_gas),
        data: deployedTokenContract.methods.transfer(account.address, args.wallet,web3.utils.toWei(args.supply, `ether`), true, '0x').encodeABI(),
      },
      privateKey
    )
    const transferTokenRes = await web3.eth.sendSignedTransaction(transferTokenResult.rawTransaction)
    console.log('Transfer Token', transferTokenRes)


    // Transfer ownership
    const transferOwnershipResult = await web3.eth.accounts.signTransaction(
      {
        from: account.address,
        to: tokenAddress,
        gasPrice: web3.utils.toHex(suggestion_gas),
        data: deployedTokenContract.methods.transferOwnership(args.wallet).encodeABI(),
      },
      privateKey
    )
    const transferOwnershipRes = await web3.eth.sendSignedTransaction(transferOwnershipResult.rawTransaction)
    console.log('Transfer Ownership', transferOwnershipRes)


    return { result: true, data: `Here is the TX hash ${res.logs[0].transactionHash} & contract address: ${tokenAddress}` }
  } catch (error) {
    return { result: false, data: error }
  }
}

async function get_total_holder(contract) {
  console.log(contract)
  let myHeaders = new Headers()
  myHeaders.append('Content-Type', `application/json`)
  myHeaders.append('Accept', `application/json`)

  let requestOptions = {
    method: 'POST',
    headers: myHeaders,
    body: JSON.stringify({
      query: `query MyQuery {
  Asset(where: {id: {_eq: "${contract.toLowerCase()}"}}) {
    id
    isLSP7
    lsp4TokenName
    lsp4TokenSymbol
    lsp4TokenType
    name
    totalSupply
    owner_id
    holders(order_by: {balance: desc}) {
      balance
    }
    createdTimestamp
  }
}`,
    }),
  }

  const response = await fetch(`${process.env.LUKSO_API_ENDPOINT}`, requestOptions)
  if (!response.ok) {
    return { result: false, message: `Failed to fetch query` }
  }
  const data = await response.json()

  // Conver numbers from wei to eth
  if (data.data.Asset[0].holders) {
    return { result: true, total: data.data.Asset[0].holders.length }
  }

  return { result: false, message: `Failed to fetch query` }
}

async function get_lsp7(contract) {
  console.log(contract)
  let myHeaders = new Headers()
  myHeaders.append('Content-Type', `application/json`)
  myHeaders.append('Accept', `application/json`)

  let requestOptions = {
    method: 'POST',
    headers: myHeaders,
    body: JSON.stringify({
      query: `query MyQuery {
  Asset(where: {id: {_eq: "${contract.toLowerCase()}"}}) {
    id
    isLSP7
    lsp4TokenName
    lsp4TokenSymbol
    lsp4TokenType
    name
    totalSupply
    owner_id
    holders(order_by: {balance: desc}, limit: 10) {
      balance
      profile {
        id
        isEOA
        tags
        fullName
      }
      timestamp
    }
  }
}`,
    }),
  }

  const response = await fetch(`${process.env.LUKSO_API_ENDPOINT}`, requestOptions)
  if (!response.ok) {
    return { result: false, message: `Failed to fetch query` }
  }
  const data = await response.json()

  // Conver numbers from wei to eth
  if (data.data && data.data.Asset[0].totalSupply) {
    data.data.Asset[0].totalSupply = Web3.utils.fromWei(data.data.Asset[0].totalSupply, `ether`)

    data.data.Asset[0].holders.forEach((element, i) => {
      data.data.Asset[0].holders[i].balance = Web3.utils.fromWei(element.balance, `ether`)
    })
  }

  return data
}

async function search_profile(wallet) {
  let myHeaders = new Headers()
  myHeaders.append('Content-Type', `application/json`)
  myHeaders.append('Accept', `application/json`)

  let requestOptions = {
    method: 'POST',
    headers: myHeaders,
    body: JSON.stringify({
      query: `query MyQuery {
  search_profiles(args: {search: "${wallet}"}, limit: 3) {
    fullName
    id
    tags
    description
    links {
      title
      url
    }
  }
}`,
    }),
  }
  const response = await fetch(`${process.env.LUKSO_API_ENDPOINT}`, requestOptions)
  if (!response.ok) {
    return { result: false, message: `Failed to fetch query` }
  }
  const data = await response.json()
  return data
}

export default async function handler(req, res) {
  console.log(req.body.old_messages)
  // console.log(req.body.profile)
  // console.log(req.body.messages)

  messages.push(req.body.profile)
  if (req.body.old_messages.length > 0) messages.push(...req.body.old_messages)

  messages.push(req.body.messages)

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: messages,
      tools: tools,
    })

    console.log(`res => `, completion.choices[0].message)

    // Check if it needs to call a function/ call an API
    if (completion.choices[0].message.tool_calls && completion.choices[0].message.tool_calls.length > 0) {
      const toolCall = completion.choices[0].message.tool_calls[0]
      let result, completion2, args

      switch (completion.choices[0].message.tool_calls[0].function.name) {
        case 'create_token':
          console.log(`CREATE TOKEN`)
          args = JSON.parse(toolCall.function.arguments)
          console.log(args)
          result = await create_token(args)
          console.log(`result of create_token function => `, result)

          messages.push(completion.choices[0].message)

          messages.push({
            role: 'tool',
            tool_call_id: toolCall.id,
            content: JSON.stringify(result),
          })

          completion2 = await openai.chat.completions.create({
            model: 'gpt-4o-mini',
            messages,
            tools,
          })

          res.status(200).json({ output: completion2.choices[0].message })
          break
        case 'get_lsp7':
          args = JSON.parse(toolCall.function.arguments)
          result = await get_lsp7(args.contract)
          console.log(`get_lsp7 => `, result)

          messages.push(completion.choices[0].message)
          messages.push({
            role: 'tool',
            tool_call_id: toolCall.id,
            content: JSON.stringify(result),
          })

          completion2 = await openai.chat.completions.create({
            model: 'gpt-4o-mini',
            messages,
            tools,
          })
          res.status(200).json({ output: completion2.choices[0].message })
          break
        case 'get_total_holder':
          args = JSON.parse(toolCall.function.arguments)
          result = await get_total_holder(args.contract)
          console.log(`getTotalHolder => `, result)
          messages.push(completion.choices[0].message)
          messages.push({
            role: 'tool',
            tool_call_id: toolCall.id,
            content: JSON.stringify(result),
          })
          completion2 = await openai.chat.completions.create({
            model: 'gpt-4o-mini',
            messages,
            tools,
          })
          res.status(200).json({ output: completion2.choices[0].message })
          break
        case 'search_profile':
          args = JSON.parse(toolCall.function.arguments)
          result = await search_profile(args.wallet)
          console.log(result)

          messages.push(completion.choices[0].message) // append model's function call message
          messages.push({
            role: 'tool',
            tool_call_id: toolCall.id,
            content: JSON.stringify(result),
          })
          completion2 = await openai.chat.completions.create({
            model: 'gpt-4o-mini',
            messages,
            tools,
          })
          res.status(200).json({ output: completion2.choices[0].message })
          break
        default:
          res.status(200).json({ output: completion.choices[0].message })
          break
      }
    } else {
      res.status(200).json({ output: completion.choices[0].message })
    }
  } catch (err) {
    res.status(500).json({ error: 'failed to load data', message: err })
  }
}
